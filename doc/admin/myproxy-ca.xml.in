<?xml version="1.0" encoding="UTF-8" ?>
 
<chapter id="myproxy-ca">
<?dbhtml filename="@DOC_DIR@/admin/myproxy-ca.html" ?>
<title>Using MyProxy as the Backend CA</title>
 
<para>
  This page has directions for configuring the GridShib-CA to use a
  <ulink url="http://myproxy.ncsa.uiuc.edu">MyProxy</ulink>-based CA.
  The MyProxy server can be running either on the same host as the
  GridShib-CA or a remote host.
</para>
<para>If you elect to use a MyProxy CA instead of the default OpenSSL CA, it
is assumed you have some experience with Grid certificate
management and have access to a PKI infrastructure and know how to get
certificates. So these directions, out of necessity, skip over these
details which are specific to your local environment.</para>
<para>Note that you probably don't want to use the same MyProxy server for
GridShib-CA and anything else.  These directions assume a MyProxy
server dedicated to a GridShib-CA.  It's possible in theory to use it
for other things, but you'll need to figure out how to tweak the
configuration yourself.</para>
<note>
  <para>
    You should use MyProxy version 4.4 or later, as earlier versions
    have problems handling certain Shibboleth identities (see <ulink
    url="http://bugzilla.globus.org/bugzilla/show_bug.cgi?id=6560">Bug
    6560</ulink>).
  </para>
</note>
<sect1 id="myproxy-ca-prerequisites">
<title>Prerequisites</title>
<itemizedlist>
<listitem><para>You need to have the IO::Net::SSL perl module
installed on the GridShib-CA system (and it's prerequisite
NET::SSLeay).</para></listitem>
</itemizedlist>
</sect1>
<sect1 id="myproxy-gridshibca-config">
<title>Configuring the GridShib CA to use MyProxy</title>
<para>You need to create a set of credentials for the GridShib CA to
use when contacting the MyProxy server. The DN of these credentials
can be whatever you want, just remember it for subsequent steps where
it will be referred to as the <emphasis>GridShib-CA DN</emphasis>. For
the purposes of these installation instructions, we will assume a DN
of "/C=US/O=NCSA-TEST/OU=User/CN=SP-Service", adjust them to match
your chosen DN.</para>
<para>Install the created credentials (certificate and key
respectively) in the following locations. (You can install them in an
alternate location, in which case you will need to adjust the
MyProxyClientCert and MyProxyClientKey parameters in gridshib-ca.conf
as described subsequently.)</para>
<itemizedlist>
<listitem><para>/tmp/gridshib-ca//myproxy-client-cert.pem</para></listitem>
<listitem><para>/tmp/gridshib-ca//myproxy-client-key.pem</para></listitem>
</itemizedlist>
<para>You need to make sure they are owned by the user under which the
Apache httpd runs. Permissions should be as shown here:
<screen>
-rw-------  1 apache root 1387 Jun  2 16:24 myproxy-client-cert.pem
-rw-------  1 apache root 1679 Jun  2 16:24 myproxy-client-key.pem
</screen></para>
<para>Next you need to edit the file
<emphasis>/tmp/gridshib-ca//gridshib-ca.conf</emphasis> and modify the
following parameters:
<itemizedlist>
<listitem><para><emphasis>caModule</emphasis>: Change this setting
	to <emphasis>GridShibCA::MyProxyCA</emphasis></para></listitem>
<listitem><para><emphasis>MyProxyHostname</emphasis>: Set this value
to the hostname where the MyProxy server is running</para></listitem>
<listitem><para><emphasis>MyProxyPort</emphasis>: Set this value to
the port number of the MyProxy server (7512 is the
default)</para></listitem>
<listitem><para><emphasis>MyProxyClientCert</emphasis>: Set this value
to the path of the certificate to use to authenticate to the MyProxy
server</para></listitem>
<listitem><para><emphasis>MyProxyClientKey</emphasis>: Set this value
to the path of the key to use to authenticate to the MyProxy
server</para></listitem>
</itemizedlist></para>
</sect1>
<sect1 id="myproxy-config">
<title>Configuring the MyProxy Server</title>
<para>On the MyProxy server system, do the following. These steps give
the GridShib-CA to request and receive any certificate from the
MyProxy CA with the mapapp program specifying which certificates are
generated.</para>
<orderedlist>
<listitem><para>The MyProxy server must
be <ulink url="http://grid.ncsa.uiuc.edu/myproxy/ca/">configured to
act as a CA</ulink></para></listitem>
<listitem><para>In /etc/myproxy-server.config set
authorized_retrievers to the GridShib-CA DN. For example:
<screen>
authorized_retrievers "/C=US/O=NCSA-TEST/OU=User/CN=SP-Service"
</screen></para></listitem>
<listitem><para>In /etc/myproxy-server.config trusted_retrievers must
include the GridShib-CA DN. For example:
<screen>
trusted_retrievers      "/C=US/O=NCSA-TEST/OU=User/CN=SP-Service"
</screen></para></listitem>
<listitem><para>In /etc/myproxy-server.config default_trusted_retrievers must
include the GridShib-CA DN. For example:
<screen>
default_trusted_retrievers      "/C=US/O=NCSA-TEST/OU=User/CN=SP-Service"
</screen></para></listitem>
<listitem><para>From the GridShib-CA system, copy the file
"/tmp/gridshib-ca//myproxy-mapapp.pl" to somewhere on the MyProxy
server. It should be installed owned by root and with permissions
0700. For these directions we assume you installed it as
"/usr/local/bin/myproxy-mapapp.pl".  If you are running the myproxy
server on the same system as the GridShib-CA you can just leave this
file where it is and specify its path in the next step.  If you did
not specify --with-relative-dn during configuration, you will need to
edit this file and set the value for <emphasis>$namespace</emphasis>
to the correct relative DN for your MyProxy CA. This value must be in
OpenSSL format (e.g. /C=US/O=NCSA-TEST/OU=User/).</para></listitem>
<listitem><para>In /etc/myproxy-server.config set certificate_mapapp
to the path of mapapp.pl. For example:
<screen>
certificate_mapapp        "/usr/local/bin/mapapp.pl"
</screen></para></listitem>
<listitem><para>If the MyProxy server is already running, restart the
myproxy server by killing it and restarting it in order to reload the
configuration. (Running "/etc/init.d/myproxy stop; /etc/init.d/myproxy
start" should do it.)</para></listitem>
</orderedlist>
</sect1>
</chapter>
