<html>
<head>
<!-- $Id$ -->
<title>GridShib CA: Installation</title>
<!-- global style sheet -->
<link rel="stylesheet" type="text/css" href="/styles/global.css" />

<!-- local style sheet -->
<link rel="stylesheet" type="text/css" href="/styles/local.css" />
</head>
@DOC_HEADER@
<h1>GridShib-CA Installation Directions</h1>
<h2>Table of Contents</h2>
<ul>
<li><a href="#prerequisties">Prerequisites</a>
<li><a href="#shib-conf">Shibboleth Configuration</a>
<li><a href="#download">Download GridShib-CA</a>
<li><a href="#install">Installing the Software</a>
<li><a href="#ca-install">CA Installation</a>
<li><a href="#conf">Configuration Options</a>
<li><a href="#test">Testing</a>
<li><a href="#troubleshooting">Troubleshooting</a>
</ul>
<p>
<h2><a name="prerequisites">Prerequisites</a></h2>
The system on which you install the GridShib CA needs the following
software installed:
<ul>
<li><a href="http://httpd.apache.org/">Apache HTTP Server</a> (Tested
with 2.0.54).<br>  You need to have HTTPS/SSL configured on the server
(the best documentation for this seems to be the file
README.QUICKSTART.SSL which should be included with your server.)
<li><a href="http://shibboleth.internet2.edu/latest.html">Shibboleth
		SP software</a> (Tested with 1.3)
<li><a href="http://www.perl.org">Perl</a> (Tested with 5.8.x)
<li><a href="http://www.openssl.org">OpenSSL</a> Both the binary
	and the development libraries and header files. (Tested with 0.9.7f)
</ul> 
<h2><a name="shib-conf">Shibboleth Configuration</a></h2>
You need to configure Shibboleth so that you have a Shibboleth
protected cgi-bin directory into which you will subsequently install
the GridShib-CA cgi-bin scripts. You can find the directions for
installing and configuring Shibboleth on the
<a
	 href="https://authdev.it.ohio-state.edu/twiki/bin/view/Shibboleth/WebHome">Shibboleth
	wiki</a>.
<p>
For the purposes of these installation directions it is
assumed that the URL for the Shibboleth-protected cgi-bin directory is
/cgi-bin/shib-protected/, if not adjust accordingly.
<h2><a name="downlaod">Download GridShib-CA</a></h2>
The source code for the GridShib
	CA: <a href="/downloads/gridshib-ca-@PACKAGE_VERSION@.tar.gz">gridshib-ca-@PACKAGE_VERSION@-tar.gz</a>
<h2><a name="install">Installing the Software</a></h2>
These directions assume you are installing GridShib-CA with version
@PACKAGE_VERSION@. If not replace all instances of @PACKAGE_VERSION@
with the version you are actually installing.
<ol>
<li>Unpack the gridshib-ca tarball and cd into the resulting
	directory. 
<pre>
% tar xfz gridshib-ca-@PACKAGE_VERSION@.tar.gz
% cd gridshib-ca-@PACKAGE_VERSION@
</pre>
<li>Run "configure". configure takes a number of arguments, which can
	be viewed by running "configure --help". Assuming you are using the 
  default paths configure should handle most of the work for you, the
	only help you may need to give it would be to specify the following:
<pre>
--with-www-user=&lt;username&gt;
</pre>
If the username that your Apache HTTPD runs under is something other
than "apache" you need to tell configure this with '-with-www-user'
<pre>
--with-www-dir=&lt;path&gt;
</pre>
If your Apache root directory is not "/var/www/" then you need to tell
configure this with '--with-www-dir'.
<li>Run "make" - don't be surprised if this does little or nothing as
	a lot of work is done by configure.
<li>As root, run "make install"
</ol>
<h2><a name="ca-install">CA Installation</a></h2>
You need to install the CA certificate and private key for the GridShib
CA. Running the script
<a href="perl/create-openssl-ca.html">utils/create-openssl-ca.pl</a>
will generate these automatically for you, creating a CA based on some
defaults or the options you provided to configure.
<p>
Now got to <a href="#test">Testing</a>
<h2><a name="conf">Configuration Options</a></h2>
The GridShib-CA uses the file
/usr/local/gridshib-ca-@PACKAGE_VERSION@/gridshib-ca.conf to control
a number of configuration options, including:
<ul>
<li>What PERL modules are used to accomplish tasks, allowing
	deployment modification of behavior;
<li>Syslog options to control how the GridShib-CA logs;
<li>Locations of files including the CA certificate, private key;
<li>Where issued certificates are stored.
</ul>
By default the values in the file should work without modification.
The file is commented and self-documenting, so all the options are
not described here. The general form of the file looks like the
following:
<pre>
######################################################################
#
# Configuration files
# 

# GridShib CA configuration directory
GridShibCAConfDir = /usr/local/gridshib-ca-0.2.1-test

# JNLP file template
JNLPTemplate = $(GridShibCAConfDir)/CredentialRetriever.jnlp

# Symetric key file for tokens
TokenKeyFile = $(GridShibCAConfDir)/token-key
</pre>
A pound character (#) indicates a comment. Everything from the # to
the end of the line is ignored.
<p>
A string such a <i>$(var)</i> is replaced with the variable as defined
elsewhere in the file. Recursion is allowed to a depth of 10.
<p>
<h2><a name="test">Testing</a></h2>
Here are some steps to test your GridShib-CA installation. Note that
it's normal to get some browser warnings/questions about trusting
certificates, both for web sites and Java Web Start applications, as
you go through the process.
<ol>
<li>Fire up your favorite browser and point it at
https://hostname/gridshib-ca-@PACKAGE_VERSION@ replacing hostname with
the name of the host on which you installed the GridShib-CA. <b>Be
sure to use 'https'.</b><br> If this didn't work then something is
fundamentally broken. Each Apache isn't installed right or a 404 error
indicates your installation didn't put the files in the right place
and you need to go review the configure options, the most likely
culprit being --with-www-dir.
<li>Click on the link entitled "make sure you have the system
	properly configured".<br>
<li>This should bring up a page that checks to see if you have Java
Web Start installed.
<li> If that looks ok, then click on the "Check Prerequisites"
button. This should launch a Java Web Start application on your local
machine. If that looks good, then you should be ready to move
on. Otherwise you have some issue with either Java Web Start not
functioning or a basic installation problem.
<li>Click "OK" to close the test application.
<li>Now click on "Return to GridShib CA" at the bottom of the page.
<li>Now go for it and click on "Shibboleth logon to generate Grid
	credentials".
<li>At this point, assuming your Shibboleth SP is correctly
	configured, you should be set either to a WAYF site to select your
	home institution or directly to a Shibboleth IdP. If this doesn't
	work, your Shibboleth configuration is incorrect and you need to
	work on that. If you don't have Shibboleth Idp you can use, register
	at <a href="http://www.openidp.org">OpenIdp</a>.
<li>You should now see a welcome message and the DN that you will
	receive. Click "Press here to generate and download Grid
	credential."
<li>A Java Web Start application should now launch and download your
	grid credential. Once is successfully completes, click "OK" to close
	it.
<li>On the command line, you should now be able to see your grid
	credential by running grid-proxy-info. For example:
<pre>
% grid-proxy-info
subject  : /C=US/O=NCSA-TEST/OU=User/CN=vwelch@openidp.org
issuer   : /C=US/O=NCSA-TEST/OU=GridShib/CN=SP-CA
identity : /C=US/O=NCSA-TEST/OU=User/CN=vwelch@openidp.org
type     : end entity credential
strength : 1024 bits
path     : /tmp/x509up_u501
timeleft : 11:58:12
</pre>
<li>If you got this far you are good to go.
</ol>
<h2><a name="troubleshooting">Troubleshooting</a></h2>
Problems with the GridShib-CA can be tricky to diagnosis because they
could be Apache, Shibboleth or GridShib-CA problems. The first step is
to figure out with which of these components the problem
lies. Checking the following logs is a good way to do that:
<ol>
<li>Check your system logs (e.g. /var/log/messages) for messages. The
	GridShib-CA scripts will log errors here.
<li>Check your apache ssl_error_logs
	(e.g. /var/log/http/ssl_error_logs) for messages. Errors encountered
	by Apache will be logged here.
<li>Check your Shibboleth logs. Check
	log4j.appender.shibd_log.fileName in /etc/shibboleth/shid.logger for
	the location of this log.
</ol>
@DOC_FOOTER@
</html>
