<html>
<head>
<!-- $Id$ -->
<title>GridShib CA: Installation</title>
<!-- global style sheet -->
<link rel="stylesheet" type="text/css" href="/styles/global.css" />

<!-- local style sheet -->
<link rel="stylesheet" type="text/css" href="/styles/local.css" />
</head>
@DOC_HEADER@
<h1>GridShib-CA Installation Directions</h1>
<h2>Table of Contents</h2>
<ul>
<li><a href="#prerequisties">Prerequisites</a>
<li><a href="#shib-conf">Shibboleth Configuration</a>
<li><a href="#download">Download GridShib-CA</a>
<li><a href="#install">Installing the Software</a>
<li><a href="#ca-conf">CA Configuration</a>
<li><a href="#openssl">OpenSSL CA Configuration</a>
<li><a href="#myproxy">MyProxy CA Configuration</a>
<li><a href="#test">Testing</a>
<li><a href="#troubleshooting">Troubleshooting</a>
</ul>
<p>
<h2><a name="prerequisites">Prerequisites</a></h2>
The system on which you install the GridShib CA needs the following
software installed:
<ul>
<li><a href="http://httpd.apache.org/">Apache HTTP Server</a> (Tested
with 2.0.54).<br>  You need to have HTTPS/SSL configured on the server
(the best documentation for this seems to be the file
README.QUICKSTART.SSL which should be included with your server.)
<li><a href="http://shibboleth.internet2.edu/latest.html">Shibboleth
		SP software</a> (Tested with 1.3)
<li><a href="http://www.perl.org">Perl</a> (Tested with 5.8.x)
</ul>
<p>
You also need some CA software. Your choices are:
<ul>
<li><a href="http://www.openssl.org">OpenSSL</a> (Tested with 0.9.7f)
<li><a href="http://myproxy.ncsa.uiuc.edu">MyProxy</a> (Tested with
	3.5). You need client software installed on the system hosting the
	GridShib-CA and a MyProxy CA installed either locally or on a
	machine that is network-accessible to the GridShib-CA.
</ul> 
<h2><a name="shib-conf">Shibboleth Configuration</a></h2>
You need to configure Shibboleth so that you have a Shibboleth
protected cgi-bin directory into which you will subsequently install
the GridShib-CA cgi-bin scripts. You can find the directions for
installing and configuring Shibboleth on the
<a
	 href="https://authdev.it.ohio-state.edu/twiki/bin/view/Shibboleth/WebHome">Shibboleth
	wiki</a>.
<p>
For the purposes of these installation directions it is
assumed that the URL for the Shibboleth-protected cgi-bin directory is
/cgi-bin/shib-protected/, if not adjust accordingly.
<h2><a name="downlaod">Download GridShib-CA</a></h2>
The source code for the GridShib
	CA: <a href="gridshib-ca-@PACKAGE_VERSION@.tar.gz">gridshib-ca-@PACKAGE_VERSION@-tar.gz</a>
<h2><a name="install">Installing the Software</a></h2>
These directions assume you are installing GridShib-CA with version
@PACKAGE_VERSION@. If not replace all instances of @PACKAGE_VERSION@
with the version you are actually installing.
<ol>
<li>Unpack the gridshib-ca tarball and cd into the resulting
	directory. 
<pre>
% tar xfz gridshib-ca-@PACKAGE_VERSION@.tar.gz
% cd gridshib-ca-@PACKAGE_VERSION@
</pre>
<li>Run "configure". configure takes a number of arguments, which can
	be viewed by running "configure --help". Assuming you are using the 
  default paths configure should handle most of the work for you, the
	only help you may need to give it would be to specify the following:
<pre>
--with-www-user=&lt;username&gt;
</pre>
If the username that your Apache HTTPD runs under is something other
than "apache" you need to tell configure this with '-with-www-user'
<pre>
--with-www-dir=&lt;path&gt;
</pre>
If your Apache root directory is not "/var/www/" then you need to tell
configure this with '--with-www-dir'.
<pre>
--with-ca-type=myproxy
</pre>
If you want to use MyProxy instead of the default OpenSSL CA, this is
your chance to say so. Note this involves extra configuration as
<a href="#myproxy">described below</a>, so you probably don't want to
do this unless you have a good reason.
<li>Run "make" - don't be surprised if this does little or nothing as
	a lot of work is done by configure.
<li>As root, run "make install"
</ol>
<h2><a name="ca-conf">CA Configuration</a></h2>
The next configuration step depends on which CA you selected with the
--with-ca-type argument to configure: OpenSSL (the default) or
MyProxy.
<p>
Regardless of which CA you selected, at the end of configuration the
script /usr/local/gridshib-ca-@PACKAGE_VERSION@/gridshib-ca-prog
should work. (Note that if you are using MyProxy you will need to
invoke it as the Apache user so you own the client credentials.)
<p>Here is an example of gridshib-ca-prog running successfully:
<pre>
# /usr/local/gridshib-ca-test/gridshib-ca-prog vwelch@uiuc.edu
GRIDSHIB-CA-SUCCESS
-----BEGIN CERTIFICATE-----
MIICiTCCAXECAQcwDQYJKoZIhvcNAQEEBQAwTzELMAkGA1UEBhMCVVMxEjAQBgNV
BAoTCU5DU0EtVEVTVDERMA8GA1UECxMIR3JpZFNoaWIxGTAXBgNVBAMTEEdyaWRT
...snip...
2+rVxoisc1fAPCvbYv8fZEW4e3bvFb8CXyoVRoQ=
-----END CERTIFICATE-----
-----BEGIN RSA PRIVATE KEY-----
MIICXAIBAAKBgQDCPA7I14kS/F/aAiSxlccBHYEFo8pl5j4wwcBpOZa6nJqlA9EA
...snip...
3xOzxXjsehDhB73UvoO8/3/P9VVDxNR6qZZuzxnyfrg=
-----END RSA PRIVATE KEY-----
</pre>
<h2><a name="openssl">OpenSSL CA Configuration</a></h2> 
If you are using the OpenSSL CA (which is the default), you need to
Install the CA certificate and private key for the GridShib
CA. Running the script "utils/create-openssl-ca.pl" will generate
these automatically for you, creating a CA based on some defaults or
the options you provided to configure.
<p>
 If you already have a CA certificate and key you want to use, you
need to install them as
/usr/local/gridshib-ca-@PACKAGE_VERSION@/gridshib-ca-cert.pem and
gridshib-ca-key.pem respectively. You need to make sure they are owned
by the user under which the Apache httpd runs. Permissions must be set
as shown here:
<pre>
-rw-------  1 apache root 1387 Jun  2 16:24 gridshib-ca-cert.pem
-rw-------  1 apache root 1679 Jun  2 16:24 gridshib-ca-key.pem
</pre>
Now got to <a href="#test">Testing</a>
<h2><a name="myproxy">MyProxy CA Configuration</a></h2>
If you elect to use a MyProxy CA instead of the default OpenSSL CA, it
is assumed you have some experience with Grid certificate
management and have access to a PKI infrastructure and know how to get
certificates. So these directions, out of necessity, skip over these
details which are specific to your local environment.
<p>
Note that you probably don't want to use the same MyProxy server for
GridShib-CA and anything else.  These directions assume a MyProxy
server dedicated to a GridShib-CA.  It's possible in theory to use it
for other things, but you'll need to figure out how to tweak the
configuration yourself.
<p>
On the GridShib-CA system:
<ol>
<li>You need to create a set of credentials for the GridShib CA to use
	when contacting the MyProxy server. The DN of these credentials can
	be whatever you want, just remember it for subsequent steps where it
	will be referred to as the <i>GridShib-CA DN</i>. For the
	purposes of these installation instructions, we will assume a DN of
	"/C=US/O=NCSA-TEST/OU=User/CN=SP-Service", adjust them to match your
	chosen DN.
<li>You need to install the credentials as
/usr/local/gridshib-ca-@PACKAGE_VERSION@/myproxy-client-cert.pem and
/usr/local/gridshib-ca-@PACKAGE_VERSION@/myproxy-client-key.pem. You
need to make sure they are owned by the user under which the Apache
httpd runs. Permissions should be as shown here:
<pre>
-rw-------  1 apache root 1387 Jun  2 16:24 myproxy-client-cert.pem
-rw-------  1 apache root 1679 Jun  2 16:24 myproxy-client-key.pem
</pre>
<li>If your myproxy server is not running on the local host and
	default port (7512), then you need to edit
	/usr/local/gridshib-ca-@PACKAGE_VERSION@ and set $MYPROXY_HOST and
	$MYPROXY_PORT appropriately.
<li>If your myproxy server is used a certificate with a distinguished
	name that is not the default (i.e. has a commonName other than
	"host/hostname"), then you need to edit 
	/usr/local/gridshib-ca-@PACKAGE_VERSION@ and set $MYPROXY_SERVER_DN
	to the distinguished name it is using.
</ol>
On the MyProxy server system, do the following. These steps give the
GridShib-CA to request and receive any certificate from the MyProxy CA
with the mapper program specifying which certificates are generated.
<ol>
<li>The MyProxy server must
	be <a href="http://grid.ncsa.uiuc.edu/myproxy/ca/">configured to act
		as a CA</a>
<li>In /etc/myproxy-server.config set authorized_retrievers to the
	GridShib-CA DN. For example:
<pre>
authorized_retrievers      "/C=US/O=NCSA-TEST/OU=User/CN=SP-Service"
</pre>
<li>In /etc/myproxy-server.config trusted_retrievers must include the
	GridShib-CA DN. For example:
<pre>
trusted_retrievers      "/C=US/O=NCSA-TEST/OU=User/CN=SP-Service"
</pre>
<li>In /etc/myproxy-server.config default_trusted_retrievers must
include the GridShib-CA DN. For example:
<pre>
default_trusted_retrievers      "/C=US/O=NCSA-TEST/OU=User/CN=SP-Service"
</pre>
<li>From the GridShib-CA system, copy the file
	/usr/local/gridshib-ca-@PACKAGE_VERSION@/mapper.sh to somewhere on
	the MyProxy server. It should be installed owned by root and with
	permissions 0600. For these directions we assume you installed it as
	/usr/local/bin/mapper.sh. If you are running the myproxy server on
	the same system as the GridShib-CA you can just leave this file
	where it is and specify its path in the next step.
<li>In /etc/myproxy-server.config set certificate_mapapp to the path
	of mapper.sh. For example:
<pre>
certificate_mapapp        "/usr/local/bin/mapper.sh"
</pre>
<li>If the MyProxy server is already running, restart the myproxy
server by killing it and restarting it in order to reload the
configuration. (Running "/etc/init.d/myproxy stop; /etc/init.d/myproxy
	start" should do it.)
<li>Proceed to <a href="#test">Testing</a>
</ol>
<h2><a name="test">Testing</a></h2>
Here are some steps to test your GridShib-CA installation. Note that
it's normal to get some browser warnings/questions about trusting
certificates, both for web sites and Java Web Start applications, as
you go through the process.
<ol>
<li>Fire up your favorite browser and point it at
https://hostname/gridshib-ca-@PACKAGE_VERSION@ replacing hostname with
the name of the host on which you installed the GridShib-CA. <b>Be
sure to use 'https'.</b><br> If this didn't work then something is
fundamentally broken. Each Apache isn't installed right or a 404 error
indicates your installation didn't put the files in the right place
and you need to go review the configure options, the most likely
culprit being --with-www-dir.
<li>Click on the link entitled "make sure you have the system
	properly configured".<br>
<li>This should bring up a page that checks to see if you have Java
Web Start installed.
<li> If that looks ok, then click on the "Check Prerequisites"
button. This should launch a Java Web Start application on your local
machine. If that looks good, then you should be ready to move
on. Otherwise you have some issue with either Java Web Start not
functioning or a basic installation problem.
<li>Click "OK" to close the test application.
<li>Now click on "Return to GridShib CA" at the bottom of the page.
<li>Now go for it and click on "Shibboleth logon to generate Grid
	credentials".
<li>At this point, assuming your Shibboleth SP is correctly
	configured, you should be set either to a WAYF site to select your
	home institution or directly to a Shibboleth IdP. If this doesn't
	work, your Shibboleth configuration is incorrect and you need to
	work on that. If you don't have Shibboleth Idp you can use, register
	at <a href="http://www.openidp.org">OpenIdp</a>.
<li>You should now see a welcome message and the DN that you will
	receive. Click "Press here to generate and download Grid
	credential."
<li>A Java Web Start application should now launch and download your
	grid credential. Once is successfully completes, click "OK" to close
	it.
<li>On the command line, you should now be able to see your grid
	credential by running grid-proxy-info. For example:
<pre>
% grid-proxy-info
subject  : /C=US/O=NCSA-TEST/OU=User/CN=vwelch@openidp.org
issuer   : /C=US/O=NCSA-TEST/OU=GridShib/CN=SP-CA
identity : /C=US/O=NCSA-TEST/OU=User/CN=vwelch@openidp.org
type     : end entity credential
strength : 1024 bits
path     : /tmp/x509up_u501
timeleft : 11:58:12
</pre>
<li>If you got this far you are good to go.
</ol>
<h2><a name="troubleshooting">Troubleshooting</a></h2>
Problems with the GridShib-CA can be tricky to diagnosis because they
could be Apache, Shibboleth or GridShib-CA problems. The first step is
to figure out with which of these components the problem
lies. Checking the following logs is a good way to do that:
<ol>
<li>Check your system logs (e.g. /var/log/messages) for messages. The
	GridShib-CA scripts will log errors here.
<li>If you are using MyProxy, it will also log to the local system
	logs on the system on which it is installed.
<li>Check your apache ssl_error_logs
	(e.g. /var/log/http/ssl_error_logs) for messages. Errors encountered
	by Apache will be logged here.
<li>Check your Shibboleth logs. Check
	log4j.appender.shibd_log.fileName in /etc/shibboleth/shid.logger for
	the location of this log.
</ol>
Some common errors and their causes:
<ol>
<li><b>Fatal Error: Got no data from server trying to read
		Credential.</b> from Credential Retriever Java Web Start
	application usually indicates Apache got an error running the
	GridShib-CA, check the Apache ssl_error_logs for messages.
</ol>
@DOC_FOOTER@
</html>
