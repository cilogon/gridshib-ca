#!/bin/sh
######################################################################
#
# This script is run by the deploy-test make target on the GridShib-CA
# test system to build and deploy the test GridShib-CA.
#
# $Id$
#
######################################################################
#
# Exit on any error

set -e

######################################################################

gscaDirName="gridshib-ca-test-@PACKAGE_VERSION_STRING@"

######################################################################

wwwDir=/var/www/${gscaDirName}
confDir=/usr/local/${gscaDirName}
cgiDir=/usr/lib/cgi-bin/shib-protected/${gscaDirName}

echo "Removing any old deployment..."
for dir in ${wwwDir} ${confDir} ${cgiDir} ; do 
    if test -d ${dir} ; then
	echo "Removing ${dir}"
	sudo rm -r ${dir}
    fi
done

######################################################################

conf_opts="\
--with-gridshib-ca-dir-name=${gscaDirName} \
--with-gridshib-ca-html_dir=${wwwDir} \
--with-shib-protected-cgi-bin-dir=${cgiDir} \
--with-gridshib-ca-conf-dir=${confDir} \
--with-globus-location=/usr/local/globus \
--with-openssl-path=/usr/bin/ \
--with-www-user=www-data \
"

echo "Running configure..."
echo "Options are: $conf_opts"

./configure ${conf_opts}

######################################################################

echo "Making..."
make

echo "Running tests..."
make test

echo "Installing..."
sudo make install

echo "Create CA credentials..."
sudo utils/create-openssl-ca.pl

echo "Running post-install tests..."
sudo make test-post-install

################################################################################

echo "Build and install complete."
exit 0
