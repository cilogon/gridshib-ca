#!@PERL@ -T -w
######################################################################
#
# $Id$
#
# This script is to be invoked protected by Shibboleth. It generates
# an token from REMOTE_USER and genertes a jnlp file to invole the
# CredentialRetriever Java Web Start application.
#
# This file does not have a ".pl" suffix as that seems to confuse
# some browsers and prevent them from parsing its output as a type
# JNLP.
#
######################################################################

my $JNLPtemplate = "@GRIDSHIB_CA_CONF_DIR@/CredentialRetriever.jnlp";

######################################################################

sub errorExit($)
{
  my $error_string = shift;

  use CGI;

  $cgi = new CGI;

  print $cgi->header("text/plain");

  print "ERROR: " . $error_string . "\n";

  exit(1);
}

######################################################################
#
# Main code
#

use CGI;
use CGI::Cookie;

$cgi = new CGI;

my $url = $cgi->url();
my $url_base = $cgi->url(-base=>1);


######################################################################
#
# Get the Shib SessionId
#

my %cookies = fetch CGI::Cookie;
my $shibsession = undef;
foreach my $key (keys %cookies)
{
    if ($key =~ /_shibsession_/)
    {
	$shibsession = $key . "=" . $cookies{$key}->value;
	last;
    }
}

if (!defined($shibsession))
{
    errorExit("Could not find Shibboleth session Id.");
}

######################################################################
#
# Create returned text
#

my $code_base = $url_base . "@GRIDSHIB_URL@";

# JWS can't load jar files from HTTPS with untrusted CA certificates
# Since JAR file is signed, this is a reasonable work around.
$code_base =~ s/https:/http:/;

my $genCredURL = $url_base . "@SHIB_PROTECTED_CGI_BIN_URL@/generateCred.cgi";

open(INPUT, $JNLPtemplate) || errorExit("Could not open input file $JNLPtemplate: $!");

print $cgi->header("Application/X-Java-Jnlp-File");

# For debugging
#print $cgi->header("text/plain");

while (<INPUT>) {
    s/\$\$token/$shibsession/;
    s/\$\$code_base/$code_base/;
    s/\$\$genCredURL/$genCredURL/;
    print;
}
close(INPUT);

### Local Variables: ***
### mode:perl ***
### End: ***
